<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Promise</title>
</head>
<body>
<script>
    let isFunction = value => typeof value === "Function"
    const pending = "PENDING";
    const fulfilled = "FULFILLED";
    const rejected = "REJECT";
    class myPromise {
        constructor(executor) {
            if(!isFunction(executor)) {
                throw new Error("executor must be a Function");
            }
            //添加状态
            this._status = pending;
            this._value = undefined;
            //添加成功回调函数队列
            this._fulfilledQueues = [];
            //添加失败回调函数队列
            this._rejectedQueues = [];
            //执行器
            try {
                executor(this._resolve.bind(this), this._reject.bind(this))
            } catch(err) {
                this._reject(err);
            }
        }
        _resolve(value) {
            const run = () => {
                if(this._status !== pending) return;
                this._status = fulfilled;
                //依次执行成功队列中的函数，并清空队列
                const runFulfilled = val => {
                    let cb;
                    while(cb = this._fulfilledQueues.shift()) {
                        cb(val);
                    }
                }
                //依次执行失败对垒中的函数，并清空队列
                const runRejected = error => {
                    let cb;
                    while(cb = this._rejectedQueues.shift()) {
                        cb(error);
                    }
                }
            }
            setTimeout(run, 0);
        }
        _reject(reason) {
            const run = () => {
                if(this._status !== pending) return;
                this._status = rejected;
                const runRejected = reason => {
                    let cb;
                    while(cb = this._rejectedQueues.shift()) {
                        cb(reason);
                    }
                }
            }
            setTimeout(run, 0);
        }
        //添加then方法
        then(onFulfilled, onRejected) {

        }
    }
</script>
</body>
</html>